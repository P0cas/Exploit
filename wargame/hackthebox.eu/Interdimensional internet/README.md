# Source Code

```python
from flask import Flask, Response, session, render_template
import functools, random, string, os, re

app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'tlci0GhK8n5A18K1GTx6KPwfYjuuftWw')

def calc(recipe):
    global garage
    builtins, garage = {'__builtins__': None}, {}
    try: exec(recipe, builtins, garage)
    except: pass

def GFW(func): # Great Firewall of the observable universe and it's infinite timelines
    @functools.wraps(func)
    def federation(*args, **kwargs):
        ingredient = session.get('ingredient', None)
        measurements = session.get('measurements', None)

        recipe = '%s = %s' % (ingredient, measurements)
        if ingredient and measurements and len(recipe) >= 20:
            regex = re.compile('|'.join(map(re.escape, ['[', '(', '_', '.'])))
            matches = regex.findall(recipe)
            
            if matches: 
                return render_template('index.html', blacklisted='Morty you dumbass: ' + ', '.join(set(matches)))
            
            if len(recipe) > 300: 
                return func(*args, **kwargs) # ionic defibulizer can't handle more bytes than that
            
            calc(recipe)
            # return render_template('index.html', calculations=garage[ingredient])
            return func(*args, **kwargs) # rick deterrent

        ingredient = session['ingredient'] = ''.join(random.choice(string.lowercase) for _ in xrange(10))
        measurements = session['measurements'] = ''.join(map(str, [random.randint(1, 69), random.choice(['+', '-', '*']), random.randint(1,69)]))

        calc('%s = %s' % (ingredient, measurements))
        return render_template('index.html', calculations=garage[ingredient])
    return federation

@app.route('/')
@GFW
def index():
    return render_template('index.html')
 
@app.route('/debug')
def debug():
    return Response(open(__file__).read(), mimetype='text/plain')

if __name__ == '__main__':
    app.run('0.0.0.0', port=1337)
```
jwt 조작해서 exec 이용해서 rce

---
# 첫 번째 시도

> Poc Code

```python
REDACTED

'''
Original Payload

Reference : https://stackoverflow.com/questions/59482234/is-an-execstring-builtins-none-a-secure-way-to-execute-user-inpu
Original Payload : s = "[c for c in ().__class__.__base__.__subclasses__() if c.__name__ == 'catch_warnings'][0]()._module.__builtins__['__import__']"

위 오리지날 페이로드를 한 번에 hex로 바꾸고 사용하니 중간에 에러가 난다. 그래서 다음 칸으로 띄우고 exec를 새로 실행하는 방식으로 했다.
그래서 다음 칸으로 띄우고 exec를 새로 실행하는 방식으로 하고, __builtins__ 객체를 이용해서 가져온 것을 add라는 변수에 넣어주고, add('os').system(ls)와 같은 방식으로 익스를 진행하니 에러가 나지 않았다.
그리고 subprocess를 이용해 flaks-unsign --sign -c를 이용해서 jwt를 만들어주려 했는데, 확인해보니 그냥 모듈로도 사용이 가능했다.
'''
```
위와 같이 RCE는 성공. 하지만 응답에 exec 함수에 대한 리턴 값이 포함되어 있지 않아 Blind Command Injection 시도. 하지만 요청이 안 옴. 결국 다른 방법 찾기로 함.

---
# 두 번째 시도

![](https://github.com/wjddnjs33/exploit-code/blob/main/wargame/hackthebox.eu/Interdimensional%20internet/images/oh.png?raw=true)

위와 같이 Time Based Injection을 이용해서 디렉터리와 값을 그냥 다 뽑아 내야 할 거 같은데, 문법 헷갈림 ㅋㅋ

fuck 일단 if문 활용까지 됐는데, os.listdir()의 값을 비교하면 잘 안 됨..
